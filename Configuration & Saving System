-- ===================================================================
-- JSON Library & Configuration System
-- ===================================================================
local json = {}
do -- JSON Scope
	local encode; local decode
	-- (The entire JSON library code from your script goes here)
	-- ... It's very long, so I'll omit it for brevity, but you must include it.
	json.encode = encode
	json.decode = decode
end

-- This function saves the current state of all UI elements.
function BlindHubsUiLibrary:SaveSettings()
    if not (typeof and typeof(writefile) == "function") then return end

    local configData = {
        Theme = self.CurrentThemeName,
        Transparency = 100 - (self.defaultTransparency * 100),
        IsOpaque = self.isOpaque,
        Elements = {}
    }

    for id, data in pairs(self.elementsToSave) do
        if data.element and data.element.Parent then
            configData.Elements[id] = data.element.State.Value
        end
    end

    pcall(writefile, "BlindHubConfig.json", json.encode(configData))
end

-- This function loads the settings from the file.
function BlindHubsUiLibrary:LoadSettings()
    if not (typeof and typeof(readfile) == "function" and isfile("BlindHubConfig.json")) then return end
    
    local success, encoded = pcall(readfile, "BlindHubConfig.json")
    if not success or not encoded then return end
    
    local configSuccess, data = pcall(json.decode, encoded)
    if not configSuccess or type(data) ~= "table" then return end

    self:SetTheme(data.Theme or "Orange")
    self:SetTransparency(data.Transparency or 55)
    self.isOpaque = data.IsOpaque or false
    
    if type(data.Elements) == "table" then
        for id, value in pairs(data.Elements) do
            if self.elementsToSave[id] then
                local element = self.elementsToSave[id].element
                if element and element:FindFirstChild("State") then
                    if self.elementsToSave[id].type == "ColorPicker" and type(value) == "table" then
                        element.State.Value = Color3.new(value.R, value.G, value.B)
                    else
                        element.State.Value = value
                    end
                end
            end
        end
    end
end
