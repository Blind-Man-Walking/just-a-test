--- Creates a new dropdown menu.
-- Requires: 'create' function, BORDER_COLOR variable, self.window.CurrentThemeColor, self.window.animatedGradients, self.window.staticThemeElements, self.window.allDropdowns, self.window.elementsToSave.
function BlindHubsUiLibrary:AddDropdown(options)
    options = options or {}
    local text = options.Text or "Dropdown"
    local items = options.Options or {}
    local defaultItem = items[1] or ""
    local uniqueId = (self.tabName or "Window") .. "_" .. text

    local dropdownFrame = create("Frame", { Name = text .. "_Dropdown", Size = UDim2.new(1, 0, 0, 25), BackgroundColor3 = Color3.fromRGB(45, 45, 45), Parent = self.page, ZIndex = 2 })
    
    create("UICorner", { CornerRadius = UDim.new(0.5, 0), Parent = dropdownFrame })
    local frameStroke = create("UIStroke", { Color = Color3.new(1, 1, 1), Thickness = 2, Parent = dropdownFrame })
    local frameGradient = create("UIGradient", { Color = ColorSequence.new({ ColorSequenceKeypoint.new(0, BORDER_COLOR), ColorSequenceKeypoint.new(0.5, self.window.CurrentThemeColor), ColorSequenceKeypoint.new(1, BORDER_COLOR) }), Rotation = 0, Parent = frameStroke })
    table.insert(self.window.animatedGradients, frameGradient)

    create("TextLabel", { Name = "Label", Position = UDim2.fromOffset(15, 0), Size = UDim2.new(0.6, 0, 1, 0), BackgroundTransparency = 1, Font = Enum.Font.SourceSans, Text = text, TextColor3 = Color3.fromRGB(225, 225, 225), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = dropdownFrame })
    
    local dropdownButton = create("TextButton", { Name = "Button", Size = UDim2.new(0.4, -15, 1, -4), Position = UDim2.new(1, -5, 0.5, 0), AnchorPoint = Vector2.new(1, 0.5), BackgroundColor3 = Color3.fromRGB(65, 65, 65), Font = Enum.Font.SourceSans, Text = " " .. defaultItem, TextColor3 = Color3.fromRGB(225, 225, 225), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = dropdownFrame })
    create("UIPadding", {PaddingLeft = UDim.new(0, 8), Parent = dropdownButton})
    create("UICorner", { CornerRadius = UDim.new(0.5, 0), Parent = dropdownButton })

    local state = create("StringValue", { Name = "State", Value = defaultItem, Parent = dropdownFrame })
    self.window.elementsToSave[uniqueId] = { element = dropdownFrame, type = "Dropdown" }
    
    local isOpen = false
    local positionUpdaterConnection
    local arrow = create("TextLabel", { Name = "Arrow", Size = UDim2.fromOffset(20, 20), Position = UDim2.new(1, -15, 0.5, 0), AnchorPoint = Vector2.new(1, 0.5), BackgroundTransparency = 1, Font = Enum.Font.SourceSansBold, Text = "▼", TextColor3 = Color3.fromRGB(225, 225, 225), TextSize = 12, Parent = dropdownButton })

    local optionsList = create("ScrollingFrame", { Name = "OptionsList", BackgroundColor3 = Color3.fromRGB(45, 45, 45), BorderSizePixel = 0, Visible = false, Parent = self.window.ScreenGui, ZIndex = 10, ScrollBarThickness = 5 })
    create("UICorner", { CornerRadius = UDim.new(0, 8), Parent = optionsList })
    local listStroke = create("UIStroke", { Color = self.window.CurrentThemeColor, Thickness = 1.5, Parent = optionsList })
    table.insert(self.window.staticThemeElements, {Object = listStroke, Property = "Color"})
    create("UIListLayout", { Padding = UDim.new(0, 2), SortOrder = Enum.SortOrder.LayoutOrder, Parent = optionsList })

    local function closeDropdown()
        isOpen = false
        optionsList.Visible = false
        arrow.Text = "▼"
        if positionUpdaterConnection then positionUpdaterConnection:Disconnect(); positionUpdaterConnection = nil end
    end
    
    local dropdownAPI = { close = closeDropdown }
    table.insert(self.window.allDropdowns, dropdownAPI)

    dropdownFrame.Destroying:Connect(function()
        for i, api in ipairs(self.window.allDropdowns) do if api == dropdownAPI then table.remove(self.window.allDropdowns, i); break end end
        optionsList:Destroy()
        if positionUpdaterConnection then positionUpdaterConnection:Disconnect() end
    end)
    
    dropdownButton.MouseButton1Click:Connect(function()
        isOpen = not isOpen
        if isOpen then
            for _, dropdown in ipairs(self.window.allDropdowns) do if dropdown ~= dropdownAPI then dropdown.close() end end
            local listLayout = optionsList:FindFirstChildOfClass("UIListLayout")
            local listHeight = math.min(125, (#items * 25) + ((#items - 1) * listLayout.Padding.Offset))
            optionsList.CanvasSize = UDim2.fromOffset(0, (#items * 25) + ((#items - 1) * listLayout.Padding.Offset))
            optionsList.Size = UDim2.fromOffset(dropdownButton.AbsoluteSize.X, listHeight)
            local function updatePosition() optionsList.Position = UDim2.fromOffset(dropdownButton.AbsolutePosition.X, dropdownButton.AbsolutePosition.Y + dropdownButton.AbsoluteSize.Y) end
            updatePosition()
            optionsList.Visible = true
            arrow.Text = "▲"
            positionUpdaterConnection = RunService.RenderStepped:Connect(updatePosition)
        else
            closeDropdown()
        end
    end)

    for _, itemText in ipairs(items) do
        local itemButton = create("TextButton", { Name = itemText, Size = UDim2.new(1, -4, 0, 25), BackgroundTransparency = 1, Font = Enum.Font.SourceSans, Text = " " .. itemText, TextColor3 = Color3.fromRGB(225, 225, 225), TextSize = 14, TextXAlignment = Enum.TextXAlignment.Left, Parent = optionsList })
        itemButton.MouseEnter:Connect(function() itemButton.BackgroundTransparency = 0.5; itemButton.BackgroundColor3 = Color3.fromRGB(80,80,80) end)
        itemButton.MouseLeave:Connect(function() itemButton.BackgroundTransparency = 1 end)
        itemButton.MouseButton1Click:Connect(function()
            state.Value = itemText
            dropdownButton.Text = " " .. itemText
            closeDropdown()
        end)
    end
    
    return dropdownFrame
end
